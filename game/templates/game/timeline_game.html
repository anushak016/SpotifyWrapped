<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdeliver.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
    body {
        font-family: "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(45deg, #ff9a9e, #fad0c4, #fbc2eb);
        background-size: 300% 300%;
        animation: gradientShift 10s ease infinite;
        color: black;
        text-align: center;
    }
    h1 {
        margin-top: 20px;
        color: #1db954;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }
    p {
        margin-bottom: 20px;
    }
    .song-list {
        list-style: none;
        padding: 0;
        margin: 20px auto;
        width: 50%;
        text-align: left;
        position: relative;
    }
    .song {
        padding: 10px;
        margin: 5px 0;
        background-color: #333;
        border-radius: 5px;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 1.5s ease, background-color 1.5s ease;
    }
    .song strong {
        color: #1db954;
    }
    .song span {
        color: #fff;
    }
    .song:hover {
        background-color: #444;
    }
    button {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        font-size: 16px;
        color: #fff;
        background-color: #1db954;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    button:hover {
        background-color: #1aa34a;
    }
    @media (max-width: 768px) {
        .song-list {
            width: 90%;
        }
    }
    @keyframes gradientShift {
        0% {
            background-position: 0% 50%;
        }
        50% {
            background-position: 100% 50%;
        }
        100% {
            background-position: 0% 50%;
        }
    }
</style>
    <title>here's your top 10 songs</title>
</head>
<body>
    <h1>here's your top 10 songs</h1>
    <h3>can you order them from most to least listened to?</h3>
    <p>i'm sure you know what you listen to most...(unfortunately, now i do too)</p>

    <!-- Form for submitting the timeline -->
    <form id="timeline-form" method="POST" action="{% url 'submit_timeline' %}">
        {% csrf_token %}
        <ul id="song-list" class="song-list">
            {% for song in tracks %}
                <li class="song" data-id="{{ song.id }}">
                    <strong>{{ song.title }}</strong> <span>by {{ song.artist }}</span>
                </li>
            {% endfor %}
        </ul>
        <input type="hidden" name="track_order" id="song-order">
        <button type="submit">submit</button>
    </form>

    <button id="show-correct-button">show correct answers</button>

    <script>
        // drag-and-drop
        const sortable = new Sortable(document.getElementById('song-list'), {
            animation: 150,
            onEnd: () => {
                const order = Array.from(document.querySelectorAll('.song')).map(song => song.dataset.id);
                document.getElementById('song-order').value = JSON.stringify(order);
            }
        });

        // form submission w/ AJAX
        document.getElementById('timeline-form').addEventListener('submit', function (event) {
            event.preventDefault();

            const songOrder = document.getElementById('song-order').value;
            if (!songOrder || songOrder === "[]") {
                alert("please at least try first...");
                return;
            }

            const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;

            fetch(this.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ track_order: JSON.parse(songOrder) })
            })
            .then(response => response.json())
            .then(data => {
                data.correct_order = undefined;
                data.score = undefined;
                if (data.error) {
                    alert(`error: ${data.error}`);
                } else {
                    let responseMessage;
                    if (data.score >= 1 && data.score <= 3) {
                        responseMessage = `did you bump your head recently? you only got ${data.score} right.`;
                        alert(responseMessage);
                    } else if (data.score >= 4 && data.score <= 6) {
                        responseMessage = `pretty mid, you got ${data.score} right.`;
                        alert(responseMessage);
                    } else if (data.score >= 7 && data.score <= 9) {
                        responseMessage = `yay!!! you really do know yourself, you got ${data.score} right.`;
                        alert(responseMessage);
                    } else if (data.score === 10) {
                        // Avoid duplicate messages
                        if (confirm("great job! want to try the popularity challenge?")) {
                            window.location.href = "{% url 'popularity_challenge' %}";
                        } else {
                            alert("aww, maybe next time!");
                        }
                        return; // no further message
                    } else {
                        responseMessage = `something seems off... you got ${data.score} right.`;
                        alert(responseMessage);
                    }

                    // save correct order in session
                    sessionStorage.setItem("correctOrder", JSON.stringify(data.correct_order));
                }
            })
            .catch(error => {
                console.error('error:', error);
                alert('something went wrong! please try again, if you dare.');
            });
        });

        // show right answers
        document.getElementById('show-correct-button').addEventListener('click', () => {
            const correctOrder = JSON.parse(sessionStorage.getItem("correctOrder"));

            if (correctOrder && correctOrder.length > 0) {
                const songList = document.getElementById('song-list');
                const songs = Array.from(songList.children);

                correctOrder.forEach(trackId => {
                    const trackElement = songs.find(song => song.dataset.id === trackId);
                    if (trackElement) {
                        songList.appendChild(trackElement);
                    }
                });

            alert('as you wish! the songs are now in the right order.');
            } else {
                alert("please at least try first...");
            }
        });
    </script>
</body>
</html>