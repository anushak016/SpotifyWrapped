<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Game</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1 {
            text-align: center;
        }
        p {
            text-align: center;
        }
        .song-list {
            list-style: none;
            padding: 0;
            margin: 20px auto;
            width: 50%;
        }
        .song {
            padding: 10px;
            margin: 5px 0;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: move;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease;
        }
        .song:hover {
            background-color: #e0e0e0;
        }
        .sortable-ghost {
            background-color: #007bff !important;
            color: #fff !important;
        }
        button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        @media (max-width: 768px) {
            .song-list {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <h1>Timeline Game</h1>
    <p>Drag and drop the songs to arrange them in the correct order!</p>

    <!-- Form for submitting the timeline -->
    <form id="timeline-form" method="POST" action="{% url 'submit_timeline' %}">
        {% csrf_token %}
        <ul id="song-list" class="song-list">
            {% for song in tracks %}
                <li class="song" data-id="{{ song.id }}">
                    <strong>{{ song.title }}</strong> by {{ song.artist }}
                </li>
            {% endfor %}
        </ul>
        <input type="hidden" name="track_order" id="song-order">
        <button type="submit">Submit</button>
    </form>

    <script>
        // Enable drag-and-drop functionality
        const sortable = new Sortable(document.getElementById('song-list'), {
            animation: 150,
            onEnd: () => {
                // Capture the updated song order
                const order = Array.from(document.querySelectorAll('.song')).map(song => song.dataset.id);
                document.getElementById('song-order').value = JSON.stringify(order);
            }
        });

        // Handle form submission with AJAX
        document.getElementById('timeline-form').addEventListener('submit', function (event) {
            event.preventDefault();

            const songOrder = document.getElementById('song-order').value; // JSON string of song order
            const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value; // CSRF token

            fetch(this.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ track_order: JSON.parse(songOrder) }) // Parse and send the song order
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`Error: ${data.error}`);
                } else {
                    // Display the score
                    alert(`You scored ${data.score}/${data.total}!`);

                    // Show the correct order
                    const correctOrderList = document.createElement('ul');
                    correctOrderList.style.marginTop = '20px';
                    correctOrderList.style.listStyle = 'none';
                    correctOrderList.style.padding = '0';
                    correctOrderList.style.textAlign = 'center';

                    data.correct_order.forEach(trackId => {
                        const track = [...document.querySelectorAll('.song')].find(song => song.dataset.id === trackId);
                        if (track) {
                            const listItem = document.createElement('li');
                            listItem.innerText = track.textContent;
                            listItem.style.padding = '10px';
                            listItem.style.backgroundColor = '#d4edda';
                            listItem.style.margin = '5px 0';
                            listItem.style.borderRadius = '5px';

                            correctOrderList.appendChild(listItem);
                        }
                    });

                    const feedback = document.createElement('p');
                    feedback.innerText = "Here is the correct order!";
                    feedback.style.textAlign = 'center';
                    feedback.style.fontWeight = 'bold';
                    feedback.style.marginTop = '20px';

                    document.body.appendChild(feedback);
                    document.body.appendChild(correctOrderList);

                    // Add a replay button
                    const replayButton = document.createElement('button');
                    replayButton.innerText = 'Play Again';
                    replayButton.style.display = 'block';
                    replayButton.style.margin = '20px auto';
                    replayButton.style.padding = '10px 20px';
                    replayButton.style.fontSize = '16px';
                    replayButton.style.color = '#fff';
                    replayButton.style.backgroundColor = '#28a745';
                    replayButton.style.border = 'none';
                    replayButton.style.borderRadius = '5px';
                    replayButton.style.cursor = 'pointer';

                    replayButton.onclick = () => window.location.reload();
                    document.body.appendChild(replayButton);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Something went wrong. Please try again.');
            });
        });
    </script>
</body>
</html>